package edu.fmi.ir.bookindex;

import java.awt.print.Book;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

import org.apache.lucene.analysis.standard.StandardAnalyzer;
import org.apache.lucene.document.Document;
import org.apache.lucene.document.Field;
import org.apache.lucene.document.TextField;
import org.apache.lucene.index.DirectoryReader;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.index.IndexWriterConfig;
import org.apache.lucene.queryparser.classic.QueryParser;
import org.apache.lucene.search.IndexSearcher;
import org.apache.lucene.search.Query;
import org.apache.lucene.search.ScoreDoc;
import org.apache.lucene.search.TopScoreDocCollector;
import org.apache.lucene.store.RAMDirectory;
import org.apache.lucene.util.Version;
import org.json.JSONArray;
import org.json.JSONObject;

public class BookIndex {
	private final IndexWriter writer;

	private static final String FIELD_CONTENT = "content";

	public BookIndex() throws IOException {
		final RAMDirectory indexDirectory = new RAMDirectory();
		final IndexWriterConfig config = new IndexWriterConfig(
				Version.LUCENE_46, new StandardAnalyzer(Version.LUCENE_46));
		writer = new IndexWriter(indexDirectory, config);
	}

	public void index(final String title, final String bookPath) {
		final Document document = new Document();
		try {
			final Scanner scanner = new Scanner(new File(bookPath));
			final StringBuilder builder = new StringBuilder();
			while (scanner.hasNextLine()) {
				builder.append(scanner.nextLine());
			}
			document.add(new TextField(FIELD_CONTENT, builder.toString(),
					Field.Store.YES));
			writer.addDocument(document);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	public void indexDirectory(final String directoryPath) {
		final File directory = new File(directoryPath);
		final String[] filenames = directory.list();
		for (final String filename : filenames) {
			index(filename.substring(0, filename.lastIndexOf(".")),
					directoryPath + File.separator + filename);
		}
	}

	public JSONArray query(final String queryString) {
		final JSONArray result = new JSONArray();
		try {
			final StandardAnalyzer analyzer = new StandardAnalyzer(
					Version.LUCENE_46);
			final QueryParser parser = new QueryParser(Version.LUCENE_46,
					FIELD_CONTENT, analyzer);
			final Query query = parser.parse(queryString);
			final TopScoreDocCollector collector = TopScoreDocCollector.create(
					10, true);

			final IndexSearcher searcher = new IndexSearcher(
					DirectoryReader.open(writer, false));
			searcher.search(query, collector);

			final ScoreDoc[] scoreDocs = collector.topDocs().scoreDocs;
			for (final ScoreDoc doc : scoreDocs) {
				final JSONObject docJson = new JSONObject();
				docJson.put("title", indexedBooks.get(doc.doc));
				docJson.put("relevance", doc.score);
				result.put(docJson);
			}
		} catch (Exception ex) {
			ex.printStackTrace();
		}
		return result;
	}
}
